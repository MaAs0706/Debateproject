<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Stream Typing</title>
  <style>
    #result {
      white-space: pre-wrap;
      font-family: monospace;
      border: 1px solid #ccc;
      padding: 1rem;
      width: 90%;
      max-width: 600px;
      height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h2>Ollama AI Stream (Typing Effect)</h2>
  <input type="text" id="promptInput" placeholder="Enter prompt" style="width:300px;">
  <button onclick="callAI()">Send</button>

  <h3>Response:</h3>
  <div id="result">Waiting...</div>

  <script>
    let typingQueue = [];
    let resultBox;
    let typingInterval;
    let eventSource;

    function typeNextChar() {
      if (typingQueue.length > 0) {
        const nextChar = typingQueue.shift();
        resultBox.textContent += nextChar;
        resultBox.scrollTop = resultBox.scrollHeight;
      } else {
        clearInterval(typingInterval);
        typingInterval = null;
      }
    }

    function enqueueText(text) {
      const chars = [...text]; // Correctly handles UTF-8, emojis, etc.
      typingQueue.push(...chars);

      if (!typingInterval) {
        typingInterval = setInterval(typeNextChar, 25); // Typing speed
      }
    }

    function callAI() {
      const prompt = document.getElementById('promptInput').value;
      resultBox = document.getElementById('result');
      resultBox.textContent = "";
      typingQueue = [];

      // Close old connection if exists
      if (eventSource) {
        eventSource.close();
      }

      eventSource = new EventSource(`http://localhost:8000/generate/${encodeURIComponent(prompt)}`);

      eventSource.onmessage = function (event) {
        if (event.data && event.data.startsWith("[Error")) {
          // Print error as-is
          resultBox.textContent += `\n${event.data}\n`;
          eventSource.close();
          return;
        }
        enqueueText(event.data);
      };

      eventSource.onerror = function (err) {
  // Only print if the stream ended prematurely
  if (typingQueue.length === 0) {
    resultBox.textContent += "\n[Stream closed]\n";
  }
  eventSource.close();
      };
    }
  </script>
</body>
</html>
